name: ğŸš€ Safe CI/CD Pipeline with Dynamic CORS

on:
  push:
    branches: [ main, staging ]
  pull_request:
    branches: [ main ]

env:
  PROD_BACKEND_URL: https://xai-community-backend-798170408536.asia-northeast3.run.app
  PROD_FRONTEND_URL: https://xai-community.vercel.app
  # ìŠ¤í…Œì´ì§• í™˜ê²½ URL (ì‹œë®¬ë ˆì´ì…˜ìš©)
  STAGING_BACKEND_URL: https://xai-community-backend-staging-798170408536.asia-northeast3.run.app
  STAGING_FRONTEND_URL: https://xai-community-git-staging-ktsfrank-navercoms-projects.vercel.app

jobs:
  # ğŸ” ë°±ì—”ë“œ ì•ˆì „í•œ ê²€ì¦
  backend-safe-checks:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: ğŸ”§ Install uv (GitHub Actions ìµœì í™”)
      run: |
        # GitHub Actionsì—ì„œ ë” ì•ˆì •ì ì¸ UV ì„¤ì¹˜ ë°©ë²•
        pip install --upgrade pip
        pip install uv
        
    - name: ğŸ Initialize Python with uv
      run: |
        uv python install 3.11
        uv python pin 3.11
        
    - name: ğŸ“¦ Install dependencies with uv
      run: |
        # í”„ë¡œì íŠ¸ì™€ ë™ì¼í•œ UV í™˜ê²½ êµ¬ì„±
        uv sync --frozen
        
    - name: ğŸ§ª Test package import
      run: |
        uv run python -c "import sys; print(f'Python: {sys.version}')"
        uv run python -c "import nadle_backend; print('âœ… Backend import successful')"
      
    - name: ğŸ”§ Run config tests
      run: |
        uv run pytest tests/unit/test_config_settings.py -v --tb=short
      
    - name: ğŸ” Run password tests
      run: |
        uv run pytest tests/unit/test_password.py -v --tb=short
      
    - name: ğŸ”‘ Run JWT tests
      run: |
        uv run pytest tests/unit/test_jwt.py -v --tb=short

  # ğŸ” í”„ëŸ°íŠ¸ì—”ë“œ ì•ˆì „í•œ ê²€ì¦
  frontend-safe-checks:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        
    - name: ğŸ§¹ Clean install dependencies
      run: |
        # node_modulesì™€ package-lock.json ì™„ì „ ì •ë¦¬
        rm -rf node_modules package-lock.json
        # í´ë¦° ì„¤ì¹˜
        npm install --no-audit --no-fund
        
    - name: ğŸ§ª Run basic type tests
      run: |
        npm run test -- tests/unit/types/index.test.ts --run --reporter=verbose
      
    - name: ğŸ—ï¸ Build test
      run: |
        npm run build

  # ğŸ¯ ìŠ¤í…Œì´ì§• ë°°í¬ (staging ë¸Œëœì¹˜ì—ì„œë§Œ)
  staging-deployment:
    needs: [backend-safe-checks, frontend-safe-checks]
    runs-on: ubuntu-latest
    environment: preview
    if: github.ref == 'refs/heads/staging' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”‘ Setup Google Cloud Authentication
      id: auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: ğŸ”§ Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: xai-community
        
    - name: ğŸš€ ìŠ¤í…Œì´ì§• ë°°í¬ ì‹¤í–‰
      env:
        # ê³µí†µ í™˜ê²½ë³€ìˆ˜ (Repository Secrets)
        MONGODB_URL: ${{ secrets.MONGODB_URL }}
        DATABASE_NAME: ${{ secrets.DATABASE_NAME }}
        USERS_COLLECTION: ${{ secrets.USERS_COLLECTION }}
        POSTS_COLLECTION: ${{ secrets.POSTS_COLLECTION }}
        COMMENTS_COLLECTION: ${{ secrets.COMMENTS_COLLECTION }}
        POST_STATS_COLLECTION: ${{ secrets.POST_STATS_COLLECTION }}
        USER_REACTIONS_COLLECTION: ${{ secrets.USER_REACTIONS_COLLECTION }}
        FILES_COLLECTION: ${{ secrets.FILES_COLLECTION }}
        STATS_COLLECTION: ${{ secrets.STATS_COLLECTION }}
        API_TITLE: "Xai Community API - Staging"
        API_VERSION: ${{ secrets.API_VERSION }}
        API_DESCRIPTION: "API for Xai Community - Staging Environment"
        SECRET_KEY: ${{ secrets.SECRET_KEY }}
        ALGORITHM: ${{ secrets.ALGORITHM }}
        ACCESS_TOKEN_EXPIRE_MINUTES: ${{ secrets.ACCESS_TOKEN_EXPIRE_MINUTES }}
        REFRESH_TOKEN_EXPIRE_DAYS: ${{ secrets.REFRESH_TOKEN_EXPIRE_DAYS }}
        PORT: ${{ secrets.PORT }}
        HOST: ${{ secrets.HOST }}
        MAX_COMMENT_DEPTH: ${{ secrets.MAX_COMMENT_DEPTH }}
        ENABLE_CORS: ${{ secrets.ENABLE_CORS }}
        GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        GCP_REGION: ${{ secrets.GCP_REGION }}
        # ìŠ¤í…Œì´ì§• í™˜ê²½ë³„ ê³ ìœ ê°’ (Preview Environment Secrets)
        ENVIRONMENT: ${{ secrets.ENVIRONMENT }}
        FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
        ALLOWED_ORIGINS: ${{ secrets.ALLOWED_ORIGINS }}
        LOG_LEVEL: ${{ secrets.LOG_LEVEL }}
        ENABLE_DOCS: ${{ secrets.ENABLE_DOCS }}
        # Sentry Configuration (ê³µí†µ DSN, í™˜ê²½ë³„ íƒœê·¸)
        SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
        SENTRY_ENVIRONMENT: staging
        SENTRY_TRACES_SAMPLE_RATE: 0.1
        SENTRY_SEND_DEFAULT_PII: false
        # Redis Configuration (ìŠ¤í…Œì´ì§•)
        UPSTASH_REDIS_REST_URL: ${{ secrets.UPSTASH_REDIS_REST_URL }}
        UPSTASH_REDIS_REST_TOKEN: ${{ secrets.UPSTASH_REDIS_REST_TOKEN }}
        # Email Configuration (Preview Environment Secrets)
        SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
        SMTP_PORT: ${{ secrets.SMTP_PORT }}
        SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
        SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        SMTP_USE_TLS: ${{ secrets.SMTP_USE_TLS }}
        FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
        FROM_NAME: ${{ secrets.FROM_NAME }}
        EMAIL_VERIFICATION_EXPIRE_MINUTES: ${{ secrets.EMAIL_VERIFICATION_EXPIRE_MINUTES }}
        EMAIL_VERIFICATION_CODE_LENGTH: ${{ secrets.EMAIL_VERIFICATION_CODE_LENGTH }}
        EMAIL_VERIFICATION_MAX_ATTEMPTS: ${{ secrets.EMAIL_VERIFICATION_MAX_ATTEMPTS }}
        # Cache Configuration (Preview Environment Secrets)
        CACHE_ENABLED: ${{ secrets.CACHE_ENABLED }}
        CACHE_TTL_USER: ${{ secrets.CACHE_TTL_USER }}
        GCP_SERVICE_NAME: xai-community-backend-staging
      run: |
        echo "ğŸ¯ ìŠ¤í…Œì´ì§• ë°°í¬ ì‹œì‘"
        echo "ğŸ“‚ Branch: ${{ github.ref }}"
        echo "ğŸ”¨ Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Author: ${{ github.actor }}"
        echo "â° ì‹œì‘ ì‹œê°„: $(date)"
        echo ""
        
        # í™˜ê²½ ì •ë³´ ì¶œë ¥
        echo "ğŸ”§ í™˜ê²½ ì •ë³´:"
        echo "  - GCP Project: $GCP_PROJECT_ID"
        echo "  - GCP Region: $GCP_REGION"
        echo "  - Service Name: $GCP_SERVICE_NAME"
        echo "  - Environment: $ENVIRONMENT"
        echo ""
        
        # gcloud ë²„ì „ í™•ì¸
        echo "ğŸ“‹ gcloud ë²„ì „ ì •ë³´:"
        gcloud version
        echo ""
        
        # ì¸ì¦ ìƒíƒœ í™•ì¸
        echo "ğŸ”‘ ì¸ì¦ ìƒíƒœ í™•ì¸:"
        gcloud auth list --filter=status:ACTIVE --format="value(account)"
        echo ""
        
        # í”„ë¡œì íŠ¸ ì„¤ì • í™•ì¸
        echo "ğŸ“ í˜„ì¬ í”„ë¡œì íŠ¸ ì„¤ì •:"
        gcloud config get-value project
        echo ""
        
        # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (ìƒì„¸ ë¡œê·¸ ì¶œë ¥)
        echo "ğŸš€ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹œì‘: $(date)"
        echo "ğŸ“‹ íŒŒì¼ ì¡´ì¬ í™•ì¸:"
        ls -la scripts/deployment/backend/deploy-staging.sh
        echo "ğŸ“‹ ìŠ¤í¬ë¦½íŠ¸ ê¶Œí•œ í™•ì¸:"
        ls -la scripts/deployment/backend/deploy-staging.sh | awk '{print $1}'
        
        # backend ë””ë ‰í† ë¦¬ë¡œ ì´ë™í•˜ì—¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        cd backend
        chmod +x ../scripts/deployment/backend/deploy-staging.sh
        ../scripts/deployment/backend/deploy-staging.sh
        DEPLOY_EXIT_CODE=$?
        
        echo "âœ… ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì™„ë£Œ: $(date)"
        echo "ğŸ“Š ë°°í¬ ê²°ê³¼: Exit Code $DEPLOY_EXIT_CODE"
        
        if [ $DEPLOY_EXIT_CODE -ne 0 ]; then
          echo "âŒ ë°°í¬ ì‹¤íŒ¨ ê°ì§€"
          exit $DEPLOY_EXIT_CODE
        fi
        
    - name: ğŸ” ìŠ¤í…Œì´ì§• í™˜ê²½ ê²€ì¦
      run: |
        echo "ğŸ” ìŠ¤í…Œì´ì§• í™˜ê²½ ê²€ì¦ ì‹œì‘"
        echo "â³ ë°°í¬ ì•ˆì •í™” ëŒ€ê¸°..."
        sleep 10
        
        # ì„œë¹„ìŠ¤ URL ê°€ì ¸ì˜¤ê¸°
        STAGING_URL=$(gcloud run services describe xai-community-backend-staging --region=asia-northeast3 --format="value(status.url)")
        echo "ğŸŒ ìŠ¤í…Œì´ì§• ì„œë¹„ìŠ¤ URL: $STAGING_URL"
        
        # í—¬ìŠ¤ì²´í¬
        echo "ğŸ” ë°±ì—”ë“œ í—¬ìŠ¤ì²´í¬..."
        if curl -f -m 30 "$STAGING_URL/health"; then
          echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ"
        else
          echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
          exit 1
        fi
        
        # ê¸°ë³¸ API í…ŒìŠ¤íŠ¸
        echo "ğŸ” ê¸°ë³¸ API í…ŒìŠ¤íŠ¸..."
        if curl -f -m 30 "$STAGING_URL/"; then
          echo "âœ… ê¸°ë³¸ API í…ŒìŠ¤íŠ¸ ì„±ê³µ"
        else
          echo "âŒ ê¸°ë³¸ API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
          exit 1
        fi
        
        echo "ğŸ‰ ìŠ¤í…Œì´ì§• í™˜ê²½ ê²€ì¦ ì™„ë£Œ!"

  # ğŸŒ í”„ë¡ íŠ¸ì—”ë“œ ìŠ¤í…Œì´ì§• ë°°í¬ ë° Git URL ì—°ê²°
  frontend-staging-deployment:
    needs: [frontend-safe-checks]
    runs-on: ubuntu-latest
    environment: preview
    if: github.ref == 'refs/heads/staging' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        
    - name: ğŸ”§ Install Vercel CLI
      run: npm install -g vercel
      
    - name: ğŸ”‘ Configure Vercel Authentication
      run: |
        echo "Vercel CLI will use token from environment variable"
      env:
        VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        
    - name: ğŸŒ Deploy Frontend to Vercel (Staging)
      env:
        VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      run: |
        echo "ğŸš€ í”„ë¡ íŠ¸ì—”ë“œ ìŠ¤í…Œì´ì§• ë°°í¬ ì‹œì‘"
        
        # frontend ë””ë ‰í„°ë¦¬ë¡œ ì´ë™
        cd frontend
        
        # Vercel í”„ë¡œì íŠ¸ ì—°ê²°
        vercel link --yes --token=$VERCEL_TOKEN
        
        # Staging í™˜ê²½ìœ¼ë¡œ ë°°í¬
        DEPLOYMENT_URL=$(vercel deploy --token=$VERCEL_TOKEN --env NODE_ENV=staging)
        echo "ğŸ“¦ ìƒˆë¡œìš´ ë°°í¬ URL: $DEPLOYMENT_URL"
        
        # Git ìŠ¤í…Œì´ì§• URLì— alias ì„¤ì •
        echo "ğŸ”— Git ìŠ¤í…Œì´ì§• URLì— alias ì„¤ì • ì¤‘..."
        vercel alias $DEPLOYMENT_URL xai-community-git-staging-ktsfrank-navercoms-projects.vercel.app --token=$VERCEL_TOKEN
        
        echo "âœ… Git ìŠ¤í…Œì´ì§• URL ì—°ê²° ì™„ë£Œ!"
        echo "ğŸŒ https://xai-community-git-staging-ktsfrank-navercoms-projects.vercel.app"
        
    - name: ğŸ” í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ê²€ì¦
      run: |
        echo "ğŸ” í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ê²€ì¦ ì‹œì‘"
        echo "â³ ë°°í¬ ì•ˆì •í™” ëŒ€ê¸°..."
        sleep 10
        
        # Git ìŠ¤í…Œì´ì§• URL í…ŒìŠ¤íŠ¸
        STAGING_FRONTEND_URL="https://xai-community-git-staging-ktsfrank-navercoms-projects.vercel.app"
        echo "ğŸŒ ìŠ¤í…Œì´ì§• í”„ë¡ íŠ¸ì—”ë“œ URL: $STAGING_FRONTEND_URL"
        
        # í—¬ìŠ¤ì²´í¬
        echo "ğŸ” í”„ë¡ íŠ¸ì—”ë“œ í—¬ìŠ¤ì²´í¬..."
        if curl -f -m 30 "$STAGING_FRONTEND_URL"; then
          echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ í—¬ìŠ¤ì²´í¬ ì„±ê³µ"
        else
          echo "âŒ í”„ë¡ íŠ¸ì—”ë“œ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
          exit 1
        fi
        
        echo "ğŸ‰ í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ê²€ì¦ ì™„ë£Œ!"

  # ğŸš€ í”„ë¡œë•ì…˜ ë°°í¬ (main ë¸Œëœì¹˜ì—ì„œë§Œ)
  production-deployment:
    needs: [backend-safe-checks, frontend-safe-checks]
    runs-on: ubuntu-latest
    environment: production
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”‘ Setup Google Cloud Authentication
      id: auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: ğŸ”§ Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: xai-community
        
    - name: ğŸš€ í”„ë¡œë•ì…˜ ë°°í¬ ì‹¤í–‰
      env:
        # ê³µí†µ í™˜ê²½ë³€ìˆ˜ (Repository Secrets)
        MONGODB_URL: ${{ secrets.MONGODB_URL }}
        DATABASE_NAME: ${{ secrets.DATABASE_NAME }}
        USERS_COLLECTION: ${{ secrets.USERS_COLLECTION }}
        POSTS_COLLECTION: ${{ secrets.POSTS_COLLECTION }}
        COMMENTS_COLLECTION: ${{ secrets.COMMENTS_COLLECTION }}
        POST_STATS_COLLECTION: ${{ secrets.POST_STATS_COLLECTION }}
        USER_REACTIONS_COLLECTION: ${{ secrets.USER_REACTIONS_COLLECTION }}
        FILES_COLLECTION: ${{ secrets.FILES_COLLECTION }}
        STATS_COLLECTION: ${{ secrets.STATS_COLLECTION }}
        API_TITLE: "Xai Community API - Production"
        API_VERSION: ${{ secrets.API_VERSION }}
        API_DESCRIPTION: "API for Xai Community - Production Environment"
        SECRET_KEY: ${{ secrets.SECRET_KEY }}
        ALGORITHM: ${{ secrets.ALGORITHM }}
        ACCESS_TOKEN_EXPIRE_MINUTES: ${{ secrets.ACCESS_TOKEN_EXPIRE_MINUTES }}
        REFRESH_TOKEN_EXPIRE_DAYS: ${{ secrets.REFRESH_TOKEN_EXPIRE_DAYS }}
        PORT: ${{ secrets.PORT }}
        HOST: ${{ secrets.HOST }}
        MAX_COMMENT_DEPTH: ${{ secrets.MAX_COMMENT_DEPTH }}
        ENABLE_CORS: ${{ secrets.ENABLE_CORS }}
        GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        GCP_REGION: ${{ secrets.GCP_REGION }}
        # í”„ë¡œë•ì…˜ í™˜ê²½ë³„ ê³ ìœ ê°’ (Production Environment Secrets)
        ENVIRONMENT: ${{ secrets.ENVIRONMENT }}
        FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
        ALLOWED_ORIGINS: ${{ secrets.ALLOWED_ORIGINS }}
        LOG_LEVEL: ${{ secrets.LOG_LEVEL }}
        ENABLE_DOCS: ${{ secrets.ENABLE_DOCS }}
        # Sentry Configuration (ê³µí†µ DSN, í™˜ê²½ë³„ íƒœê·¸)
        SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
        SENTRY_ENVIRONMENT: production
        SENTRY_TRACES_SAMPLE_RATE: 0.1
        SENTRY_SEND_DEFAULT_PII: false
        # Redis Configuration (í”„ë¡œë•ì…˜)
        UPSTASH_REDIS_REST_URL: ${{ secrets.UPSTASH_REDIS_REST_URL }}
        UPSTASH_REDIS_REST_TOKEN: ${{ secrets.UPSTASH_REDIS_REST_TOKEN }}
        GCP_SERVICE_NAME: xai-community-backend
      run: |
        echo "ğŸ¯ í”„ë¡œë•ì…˜ ë°°í¬ ì‹œì‘"
        echo "ğŸ“‚ Branch: ${{ github.ref }}"
        echo "ğŸ”¨ Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Author: ${{ github.actor }}"
        echo ""
        
        # í™˜ê²½ ì •ë³´ ì¶œë ¥
        echo "ğŸ”§ í™˜ê²½ ì •ë³´:"
        echo "  - GCP Project: $GCP_PROJECT_ID"
        echo "  - GCP Region: $GCP_REGION"
        echo "  - Service Name: $GCP_SERVICE_NAME"
        echo "  - Environment: $ENVIRONMENT"
        echo ""
        
        # í”„ë¡œë•ì…˜ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (backend ë””ë ‰í† ë¦¬ì—ì„œ)
        cd backend
        chmod +x ../scripts/deployment/backend/deploy-production.sh
        ../scripts/deployment/backend/deploy-production.sh
        
    - name: ğŸ” í”„ë¡œë•ì…˜ í™˜ê²½ ê²€ì¦
      run: |
        echo "ğŸ” í”„ë¡œë•ì…˜ í™˜ê²½ ê²€ì¦ ì‹œì‘"
        echo "â³ ë°°í¬ ì•ˆì •í™” ëŒ€ê¸°..."
        sleep 10
        
        # ì„œë¹„ìŠ¤ URL ê°€ì ¸ì˜¤ê¸°
        PRODUCTION_URL=$(gcloud run services describe xai-community-backend --region=asia-northeast3 --format="value(status.url)")
        echo "ğŸŒ í”„ë¡œë•ì…˜ ì„œë¹„ìŠ¤ URL: $PRODUCTION_URL"
        
        # í—¬ìŠ¤ì²´í¬
        echo "ğŸ” ë°±ì—”ë“œ í—¬ìŠ¤ì²´í¬..."
        if curl -f -m 30 "$PRODUCTION_URL/health"; then
          echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ"
        else
          echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
          exit 1
        fi
        
        # ê¸°ë³¸ API í…ŒìŠ¤íŠ¸
        echo "ğŸ” ê¸°ë³¸ API í…ŒìŠ¤íŠ¸..."
        if curl -f -m 30 "$PRODUCTION_URL/"; then
          echo "âœ… ê¸°ë³¸ API í…ŒìŠ¤íŠ¸ ì„±ê³µ"
        else
          echo "âŒ ê¸°ë³¸ API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
          exit 1
        fi
        
    - name: ğŸŒ Verify Production Frontend URL
      run: |
        echo "ğŸ” Production í”„ëŸ°íŠ¸ì—”ë“œ URL ê²€ì¦ ì¤‘..."
        echo "ğŸ¯ Primary Production Domain: $PROD_FRONTEND_URL"
        
        # Production Domain ì ‘ê·¼ì„± í™•ì¸
        echo "ğŸ”— Production Domain í™•ì¸: $PROD_FRONTEND_URL"
        if curl -f -m 30 -s $PROD_FRONTEND_URL > /dev/null; then
          echo "âœ… Production Domain ì ‘ê·¼ ê°€ëŠ¥"
          echo "ğŸ‰ ê³ ì • Production Domainì´ ì •ìƒ ì‘ë™ ì¤‘"
        else
          echo "âš ï¸ Production Domain ì ‘ê·¼ ë¶ˆê°€"
          echo "ğŸ“ Preview ë°°í¬ê°€ ì‚¬ìš© ì¤‘ì¼ ìˆ˜ ìˆìŒ"
        fi
        
        echo ""
        echo "ğŸ“‹ CORS ì„¤ì • ì •ë³´:"
        echo "  ğŸ¯ Primary: $PROD_FRONTEND_URL"
        echo "  ğŸ”„ Fallback: ë™ì  íŒ¨í„´ ë§¤ì¹­ í™œì„±í™”"
        echo "  ğŸ“¡ íŒ¨í„´: https://xai-community*.vercel.app"
        echo "  ğŸ” ë°±ì—”ë“œ ë¡œê·¸ì—ì„œ ì‹¤ì‹œê°„ URL ê°ì§€ í™•ì¸ ê°€ëŠ¥"
        
    - name: ğŸ§ª Test CORS functionality
      run: |
        echo "ğŸ” CORS ë™ì‘ í…ŒìŠ¤íŠ¸..."
        
        # Production Domainìœ¼ë¡œ CORS í…ŒìŠ¤íŠ¸
        echo "ğŸ“¡ Production Domain CORS í…ŒìŠ¤íŠ¸..."
        if curl -f -m 30 -H "Origin: $PROD_FRONTEND_URL" $PROD_BACKEND_URL/health; then
          echo "âœ… Production Domain CORS ì •ìƒ ì‘ë™"
        else
          echo "âš ï¸ Production Domain CORS í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
        fi
        
        # Preview URL íŒ¨í„´ìœ¼ë¡œë„ í…ŒìŠ¤íŠ¸
        echo "ğŸ“¡ Preview URL íŒ¨í„´ CORS í…ŒìŠ¤íŠ¸..."
        TEST_PREVIEW_URL="https://xai-community-test-ktsfrank-navercoms-projects.vercel.app"
        if curl -f -m 30 -H "Origin: $TEST_PREVIEW_URL" $PROD_BACKEND_URL/health; then
          echo "âœ… Preview URL íŒ¨í„´ CORS ì •ìƒ ì‘ë™"
        else
          echo "âš ï¸ Preview URL íŒ¨í„´ CORS í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ (ì •ìƒ - ì‹¤ì œ URLì´ ì•„ë‹˜)"
        fi

  # ğŸ“Š ê²°ê³¼ ì•Œë¦¼
  notification:
    needs: [backend-safe-checks, frontend-safe-checks, production-deployment, staging-deployment, frontend-staging-deployment]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ‰ Success notification
      if: needs.backend-safe-checks.result == 'success' && needs.frontend-safe-checks.result == 'success'
      run: |
        echo "ğŸ‰ ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼!"
        echo "âœ… ë°±ì—”ë“œ: ${{ needs.backend-safe-checks.result }}"
        echo "âœ… í”„ëŸ°íŠ¸ì—”ë“œ: ${{ needs.frontend-safe-checks.result }}"
        
        # ìŠ¤í…Œì´ì§• ê²°ê³¼ í‘œì‹œ (staging ë¸Œëœì¹˜ì—ì„œë§Œ)
        if [ "${{ github.ref }}" == "refs/heads/staging" ]; then
          echo "ğŸ¯ ìŠ¤í…Œì´ì§• ë°±ì—”ë“œ ë°°í¬: ${{ needs.staging-deployment.result }}"
          echo "ğŸ¯ ìŠ¤í…Œì´ì§• í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬: ${{ needs.frontend-staging-deployment.result }}"
          echo "ğŸŒ ìŠ¤í…Œì´ì§• ë°±ì—”ë“œ: $STAGING_BACKEND_URL"
          echo "ğŸŒ ìŠ¤í…Œì´ì§• í”„ëŸ°íŠ¸ì—”ë“œ: https://xai-community-git-staging-ktsfrank-navercoms-projects.vercel.app"
        fi
        
        # í”„ë¡œë•ì…˜ ê²°ê³¼ í‘œì‹œ (main ë¸Œëœì¹˜ì—ì„œë§Œ)
        if [ "${{ github.ref }}" == "refs/heads/main" ]; then
          echo "ğŸš€ í”„ë¡œë•ì…˜ ë°°í¬: ${{ needs.production-deployment.result }}"
          echo "ğŸŒ í”„ë¡œë•ì…˜ ë°±ì—”ë“œ: $PROD_BACKEND_URL"
          echo "ğŸŒ í”„ë¡œë•ì…˜ í”„ëŸ°íŠ¸ì—”ë“œ: $PROD_FRONTEND_URL"
        fi
        
    - name: âŒ Failure notification
      if: needs.backend-safe-checks.result == 'failure' || needs.frontend-safe-checks.result == 'failure' || needs.production-deployment.result == 'failure' || needs.staging-deployment.result == 'failure' || needs.frontend-staging-deployment.result == 'failure'
      run: |
        echo "âŒ ì¼ë¶€ í…ŒìŠ¤íŠ¸ ë˜ëŠ” ë°°í¬ ì‹¤íŒ¨"
        echo "ğŸ”§ ë°±ì—”ë“œ: ${{ needs.backend-safe-checks.result }}"
        echo "ğŸ”§ í”„ëŸ°íŠ¸ì—”ë“œ: ${{ needs.frontend-safe-checks.result }}"
        
        # ìŠ¤í…Œì´ì§• ì‹¤íŒ¨ í™•ì¸
        if [ "${{ github.ref }}" == "refs/heads/staging" ]; then
          echo "ğŸ¯ ìŠ¤í…Œì´ì§• ë°±ì—”ë“œ ë°°í¬: ${{ needs.staging-deployment.result }}"
          echo "ğŸ¯ ìŠ¤í…Œì´ì§• í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬: ${{ needs.frontend-staging-deployment.result }}"
        fi
        
        # í”„ë¡œë•ì…˜ ì‹¤íŒ¨ í™•ì¸
        if [ "${{ github.ref }}" == "refs/heads/main" ]; then
          echo "ğŸš€ í”„ë¡œë•ì…˜ ë°°í¬: ${{ needs.production-deployment.result }}"
        fi
        
        echo "ğŸ“ ì‹¤íŒ¨í•œ ë‹¨ê³„ë¥¼ í™•ì¸í•˜ê³  ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤"

  # ğŸ”„ ìë™ ë¡¤ë°± (ë°°í¬ ì‹¤íŒ¨ ì‹œ)
  auto-rollback:
    needs: [backend-safe-checks, frontend-safe-checks, production-deployment, staging-deployment, frontend-staging-deployment]
    runs-on: ubuntu-latest
    if: failure() && (needs.production-deployment.result == 'failure' || needs.staging-deployment.result == 'failure' || needs.frontend-staging-deployment.result == 'failure')
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”‘ Setup Google Cloud Authentication
      id: auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: ğŸ”§ Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: xai-community
        
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: ğŸ”„ Install Vercel CLI
      run: npm install -g vercel
      
    - name: ğŸ”‘ Configure Vercel
      run: |
        echo "${{ secrets.VERCEL_TOKEN }}" | vercel login --stdin || echo "Vercel login failed"
      
    - name: ğŸ”„ Execute Auto Rollback
      env:
        VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      run: |
        echo "ğŸš¨ ë°°í¬ ì‹¤íŒ¨ ê°ì§€ - ìë™ ë¡¤ë°± ì‹œì‘"
        
        # í™˜ê²½ ê²°ì •
        if [ "${{ github.ref }}" == "refs/heads/main" ]; then
          ENVIRONMENT="production"
          echo "ğŸ¯ í”„ë¡œë•ì…˜ í™˜ê²½ ìë™ ë¡¤ë°±"
        elif [ "${{ github.ref }}" == "refs/heads/staging" ]; then
          ENVIRONMENT="staging"
          echo "ğŸ¯ ìŠ¤í…Œì´ì§• í™˜ê²½ ìë™ ë¡¤ë°±"
        else
          echo "âŒ ì§€ì›ë˜ì§€ ì•ŠëŠ” ë¸Œëœì¹˜: ${{ github.ref }}"
          exit 1
        fi
        
        # ì´ì „ ì„±ê³µí•œ ì»¤ë°‹ í•´ì‹œ ì°¾ê¸°
        PREVIOUS_COMMIT=$(git log --format="%H" --skip=1 -n 1)
        echo "ğŸ“ ì´ì „ ì»¤ë°‹ìœ¼ë¡œ ë¡¤ë°±: $PREVIOUS_COMMIT"
        
        # ë¡¤ë°± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        chmod +x ./scripts/deployment/full-stack/rollback-full.sh
        chmod +x ./scripts/deployment/backend/rollback-backend.sh
        chmod +x ./scripts/deployment/frontend/rollback-frontend.sh
        
        # ìë™ ë¡¤ë°± ì‹¤í–‰ (ê²€ì¦ ê±´ë„ˆë›°ê¸°)
        if ./scripts/deployment/full-stack/rollback-full.sh -e "$ENVIRONMENT" -s; then
          echo "âœ… ìë™ ë¡¤ë°± ì„±ê³µ"
          
          # ë¡¤ë°± ê²€ì¦
          chmod +x ./scripts/monitoring/verify-rollback.sh
          if ./scripts/monitoring/verify-rollback.sh -e "$ENVIRONMENT" "$PREVIOUS_COMMIT" "$PREVIOUS_COMMIT"; then
            echo "âœ… ë¡¤ë°± ê²€ì¦ ì„±ê³µ"
          else
            echo "âš ï¸ ë¡¤ë°± ê²€ì¦ ì‹¤íŒ¨ - ìˆ˜ë™ í™•ì¸ í•„ìš”"
          fi
        else
          echo "âŒ ìë™ ë¡¤ë°± ì‹¤íŒ¨ - ìˆ˜ë™ ê°œì… í•„ìš”"
          exit 1
        fi