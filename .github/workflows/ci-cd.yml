name: ğŸš€ Safe CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PROD_BACKEND_URL: https://xai-community.onrender.com
  PROD_FRONTEND_URL: https://xai-community-id0m2v4f8-ktsfrank-navercoms-projects.vercel.app

jobs:
  # ğŸ” ë°±ì—”ë“œ ì•ˆì „í•œ ê²€ì¦
  backend-safe-checks:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ Install uv
      uses: astral-sh/setup-uv@v3
      
    - name: ğŸ”§ Set up Python
      run: uv python install
      
    - name: ğŸ“¦ Install dependencies
      run: uv sync --frozen
      
    - name: ğŸ§ª Test package import
      run: uv run python -c "import nadle_backend; print('âœ… Backend import successful')"
      
    - name: ğŸ”§ Run config tests
      run: uv run pytest tests/unit/test_config_settings.py -v
      
    - name: ğŸ” Run password tests
      run: uv run pytest tests/unit/test_password.py -v
      
    - name: ğŸ”‘ Run JWT tests
      run: uv run pytest tests/unit/test_jwt.py -v

  # ğŸ” í”„ëŸ°íŠ¸ì—”ë“œ ì•ˆì „í•œ ê²€ì¦
  frontend-safe-checks:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ§ª Run basic type tests
      run: npm run test -- tests/unit/types/index.test.ts --run --reporter=verbose
      
    - name: ğŸ—ï¸ Build test
      run: npm run build

  # ğŸš€ ë°°í¬ í›„ ê²€ì¦ (main ë¸Œëœì¹˜ì—ì„œë§Œ)
  deployment-verification:
    needs: [backend-safe-checks, frontend-safe-checks]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: â³ Wait for auto-deployment
      run: sleep 90
      
    - name: ğŸ” Check backend health
      run: |
        echo "ğŸ” ë°±ì—”ë“œ ìƒíƒœ í™•ì¸ ì¤‘..."
        if curl -f -m 30 $PROD_BACKEND_URL/health; then
          echo "âœ… ë°±ì—”ë“œ ì •ìƒ ë™ì‘ í™•ì¸"
        else
          echo "âš ï¸ ë°±ì—”ë“œ í™•ì¸ ì‹¤íŒ¨ (ê²½ê³ ë§Œ)"
        fi
        
    - name: ğŸ” Check frontend accessibility
      run: |
        echo "ğŸ” í”„ëŸ°íŠ¸ì—”ë“œ ìƒíƒœ í™•ì¸ ì¤‘..."
        if curl -f -m 30 $PROD_FRONTEND_URL; then
          echo "âœ… í”„ëŸ°íŠ¸ì—”ë“œ ì •ìƒ ë™ì‘ í™•ì¸"
        else
          echo "âš ï¸ í”„ëŸ°íŠ¸ì—”ë“œ í™•ì¸ ì‹¤íŒ¨ (ê²½ê³ ë§Œ)"
        fi

  # ğŸ“Š ê²°ê³¼ ì•Œë¦¼
  notification:
    needs: [backend-safe-checks, frontend-safe-checks, deployment-verification]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ‰ Success notification
      if: needs.backend-safe-checks.result == 'success' && needs.frontend-safe-checks.result == 'success'
      run: |
        echo "ğŸ‰ ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼!"
        echo "âœ… ë°±ì—”ë“œ: ${{ needs.backend-safe-checks.result }}"
        echo "âœ… í”„ëŸ°íŠ¸ì—”ë“œ: ${{ needs.frontend-safe-checks.result }}"
        echo "ğŸŒ ë°±ì—”ë“œ URL: $PROD_BACKEND_URL"
        echo "ğŸŒ í”„ëŸ°íŠ¸ì—”ë“œ URL: $PROD_FRONTEND_URL"
        
    - name: âŒ Failure notification
      if: needs.backend-safe-checks.result == 'failure' || needs.frontend-safe-checks.result == 'failure'
      run: |
        echo "âŒ ì¼ë¶€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
        echo "ğŸ”§ ë°±ì—”ë“œ: ${{ needs.backend-safe-checks.result }}"
        echo "ğŸ”§ í”„ëŸ°íŠ¸ì—”ë“œ: ${{ needs.frontend-safe-checks.result }}"
        echo "ğŸ“ ì‹¤íŒ¨í•œ ë‹¨ê³„ë¥¼ í™•ì¸í•˜ê³  ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤"