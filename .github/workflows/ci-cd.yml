name: ğŸš€ Safe CI/CD Pipeline with Dynamic CORS

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PROD_BACKEND_URL: https://xai-community.onrender.com
  PROD_FRONTEND_URL: https://xai-community-id0m2v4f8-ktsfrank-navercoms-projects.vercel.app

jobs:
  # ğŸ” ë°±ì—”ë“œ ì•ˆì „í•œ ê²€ì¦
  backend-safe-checks:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ”§ Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.local/bin" >> $GITHUB_PATH
      
    - name: ğŸ“¦ Install dependencies
      run: |
        uv python install 3.11
        uv sync --frozen
      
    - name: ğŸ§ª Test package import
      run: |
        uv run python -c "import nadle_backend; print('âœ… Backend import successful')"
      
    - name: ğŸ”§ Run config tests
      run: |
        uv run pytest tests/unit/test_config_settings.py -v --tb=short
      
    - name: ğŸ” Run password tests  
      run: |
        uv run pytest tests/unit/test_password.py -v --tb=short
      
    - name: ğŸ”‘ Run JWT tests
      run: |
        uv run pytest tests/unit/test_jwt.py -v --tb=short

  # ğŸ” í”„ëŸ°íŠ¸ì—”ë“œ ì•ˆì „í•œ ê²€ì¦
  frontend-safe-checks:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: ğŸ“¦ Install dependencies
      run: |
        npm ci --no-audit --no-fund
        
    - name: ğŸ§ª Run basic type tests
      run: |
        npm run test -- tests/unit/types/index.test.ts --run --reporter=verbose
      
    - name: ğŸ—ï¸ Build test
      run: |
        npm run build

  # ğŸš€ ë°°í¬ í›„ ê²€ì¦ (main ë¸Œëœì¹˜ì—ì„œë§Œ)
  deployment-verification:
    needs: [backend-safe-checks, frontend-safe-checks]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: â³ Wait for auto-deployment
      run: sleep 120
      
    - name: ğŸ” Check backend health
      run: |
        echo "ğŸ” ë°±ì—”ë“œ ìƒíƒœ í™•ì¸ ì¤‘..."
        if curl -f -m 30 $PROD_BACKEND_URL/health; then
          echo "âœ… ë°±ì—”ë“œ ì •ìƒ ë™ì‘ í™•ì¸"
        else
          echo "âš ï¸ ë°±ì—”ë“œ í™•ì¸ ì‹¤íŒ¨ (ê²½ê³ ë§Œ)"
        fi
        
    - name: ğŸŒ Detect new Vercel deployment URL
      run: |
        echo "ğŸ” ìƒˆ Vercel ë°°í¬ URL ê°ì§€ ì¤‘..."
        
        # Vercel CLI ì—†ì´ GitHub APIë¥¼ í†µí•´ ë°°í¬ ê°ì§€ ì‹œë„
        echo "ğŸ“ ë°°í¬ ì •ë³´ ìˆ˜ì§‘..."
        echo "  - Repository: ${{ github.repository }}"
        echo "  - Commit SHA: ${{ github.sha }}"
        echo "  - Branch: ${{ github.ref_name }}"
        
        # ê¸°ì¡´ URLë¡œ ì ‘ê·¼ì„± í™•ì¸
        echo "ğŸ”— ê¸°ì¡´ í”„ëŸ°íŠ¸ì—”ë“œ URL í™•ì¸: $PROD_FRONTEND_URL"
        if curl -f -m 30 -s $PROD_FRONTEND_URL > /dev/null; then
          echo "âœ… ê¸°ì¡´ URL ì ‘ê·¼ ê°€ëŠ¥"
        else
          echo "âš ï¸ ê¸°ì¡´ URL ì ‘ê·¼ ë¶ˆê°€ - ìƒˆ URLë¡œ ë°°í¬ëœ ê²ƒìœ¼ë¡œ ì¶”ì •"
        fi
        
        echo "ğŸ¯ ë™ì  CORS ì‹œìŠ¤í…œì´ ìƒˆ URLì„ ìë™ìœ¼ë¡œ ê°ì§€í•˜ê³  í—ˆìš©í•©ë‹ˆë‹¤"
        echo "   - íŒ¨í„´: https://xai-community*-ktsfrank-navercoms-projects.vercel.app"
        echo "   - ë°±ì—”ë“œ ë¡œê·¸ì—ì„œ ìƒˆ URL í™•ì¸ ê°€ëŠ¥"
        
    - name: ğŸ§ª Test CORS functionality
      run: |
        echo "ğŸ” CORS ë™ì‘ í…ŒìŠ¤íŠ¸..."
        
        # ë°±ì—”ë“œ í—¬ìŠ¤ì²´í¬ë¡œ CORS ê¸°ë³¸ ë™ì‘ í™•ì¸
        echo "ğŸ“¡ ë°±ì—”ë“œ API í˜¸ì¶œ í…ŒìŠ¤íŠ¸..."
        if curl -f -m 30 -H "Origin: https://test.vercel.app" $PROD_BACKEND_URL/health; then
          echo "âœ… CORS í—¤ë”ê°€ ì •ìƒì ìœ¼ë¡œ ì²˜ë¦¬ë¨"
        else
          echo "âš ï¸ CORS í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ (ê²½ê³ ë§Œ)"
        fi

  # ğŸ“Š ê²°ê³¼ ì•Œë¦¼
  notification:
    needs: [backend-safe-checks, frontend-safe-checks, deployment-verification]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ‰ Success notification
      if: needs.backend-safe-checks.result == 'success' && needs.frontend-safe-checks.result == 'success'
      run: |
        echo "ğŸ‰ ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼!"
        echo "âœ… ë°±ì—”ë“œ: ${{ needs.backend-safe-checks.result }}"
        echo "âœ… í”„ëŸ°íŠ¸ì—”ë“œ: ${{ needs.frontend-safe-checks.result }}"
        echo "ğŸŒ ë°±ì—”ë“œ URL: $PROD_BACKEND_URL"
        echo "ğŸŒ í”„ëŸ°íŠ¸ì—”ë“œ URL: $PROD_FRONTEND_URL"
        
    - name: âŒ Failure notification
      if: needs.backend-safe-checks.result == 'failure' || needs.frontend-safe-checks.result == 'failure'
      run: |
        echo "âŒ ì¼ë¶€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
        echo "ğŸ”§ ë°±ì—”ë“œ: ${{ needs.backend-safe-checks.result }}"
        echo "ğŸ”§ í”„ëŸ°íŠ¸ì—”ë“œ: ${{ needs.frontend-safe-checks.result }}"
        echo "ğŸ“ ì‹¤íŒ¨í•œ ë‹¨ê³„ë¥¼ í™•ì¸í•˜ê³  ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤"