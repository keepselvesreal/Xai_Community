name: ğŸš€ Safe CI/CD Pipeline with Dynamic CORS

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PROD_BACKEND_URL: https://xai-community.onrender.com
  PROD_FRONTEND_URL: https://xai-community.vercel.app

jobs:
  # ğŸ” ë°±ì—”ë“œ ì•ˆì „í•œ ê²€ì¦
  backend-safe-checks:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: ğŸ”§ Install uv (GitHub Actions ìµœì í™”)
      run: |
        # GitHub Actionsì—ì„œ ë” ì•ˆì •ì ì¸ UV ì„¤ì¹˜ ë°©ë²•
        pip install --upgrade pip
        pip install uv
        
    - name: ğŸ Initialize Python with uv
      run: |
        uv python install 3.11
        uv python pin 3.11
        
    - name: ğŸ“¦ Install dependencies with uv
      run: |
        # í”„ë¡œì íŠ¸ì™€ ë™ì¼í•œ UV í™˜ê²½ êµ¬ì„±
        uv sync --frozen
        
    - name: ğŸ§ª Test package import
      run: |
        uv run python -c "import sys; print(f'Python: {sys.version}')"
        uv run python -c "import nadle_backend; print('âœ… Backend import successful')"
      
    - name: ğŸ”§ Run config tests
      run: |
        uv run pytest tests/unit/test_config_settings.py -v --tb=short
      
    - name: ğŸ” Run password tests
      run: |
        uv run pytest tests/unit/test_password.py -v --tb=short
      
    - name: ğŸ”‘ Run JWT tests
      run: |
        uv run pytest tests/unit/test_jwt.py -v --tb=short

  # ğŸ” í”„ëŸ°íŠ¸ì—”ë“œ ì•ˆì „í•œ ê²€ì¦
  frontend-safe-checks:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: ğŸ“¦ Install dependencies
      run: |
        npm ci --no-audit --no-fund
        
    - name: ğŸ§ª Run basic type tests
      run: |
        npm run test -- tests/unit/types/index.test.ts --run --reporter=verbose
      
    - name: ğŸ—ï¸ Build test
      run: |
        npm run build

  # ğŸš€ ë°°í¬ í›„ ê²€ì¦ (main ë¸Œëœì¹˜ì—ì„œë§Œ)
  deployment-verification:
    needs: [backend-safe-checks, frontend-safe-checks]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: â³ Wait for auto-deployment
      run: sleep 120
      
    - name: ğŸ” Check backend health
      run: |
        echo "ğŸ” ë°±ì—”ë“œ ìƒíƒœ í™•ì¸ ì¤‘..."
        if curl -f -m 30 $PROD_BACKEND_URL/health; then
          echo "âœ… ë°±ì—”ë“œ ì •ìƒ ë™ì‘ í™•ì¸"
        else
          echo "âš ï¸ ë°±ì—”ë“œ í™•ì¸ ì‹¤íŒ¨ (ê²½ê³ ë§Œ)"
        fi
        
    - name: ğŸŒ Verify Production Frontend URL
      run: |
        echo "ğŸ” Production í”„ëŸ°íŠ¸ì—”ë“œ URL ê²€ì¦ ì¤‘..."
        echo "ğŸ¯ Primary Production Domain: $PROD_FRONTEND_URL"
        
        # Production Domain ì ‘ê·¼ì„± í™•ì¸
        echo "ğŸ”— Production Domain í™•ì¸: $PROD_FRONTEND_URL"
        if curl -f -m 30 -s $PROD_FRONTEND_URL > /dev/null; then
          echo "âœ… Production Domain ì ‘ê·¼ ê°€ëŠ¥"
          echo "ğŸ‰ ê³ ì • Production Domainì´ ì •ìƒ ì‘ë™ ì¤‘"
        else
          echo "âš ï¸ Production Domain ì ‘ê·¼ ë¶ˆê°€"
          echo "ğŸ“ Preview ë°°í¬ê°€ ì‚¬ìš© ì¤‘ì¼ ìˆ˜ ìˆìŒ"
        fi
        
        echo ""
        echo "ğŸ“‹ CORS ì„¤ì • ì •ë³´:"
        echo "  ğŸ¯ Primary: $PROD_FRONTEND_URL"
        echo "  ğŸ”„ Fallback: ë™ì  íŒ¨í„´ ë§¤ì¹­ í™œì„±í™”"
        echo "  ğŸ“¡ íŒ¨í„´: https://xai-community*.vercel.app"
        echo "  ğŸ” ë°±ì—”ë“œ ë¡œê·¸ì—ì„œ ì‹¤ì‹œê°„ URL ê°ì§€ í™•ì¸ ê°€ëŠ¥"
        
    - name: ğŸ§ª Test CORS functionality
      run: |
        echo "ğŸ” CORS ë™ì‘ í…ŒìŠ¤íŠ¸..."
        
        # Production Domainìœ¼ë¡œ CORS í…ŒìŠ¤íŠ¸
        echo "ğŸ“¡ Production Domain CORS í…ŒìŠ¤íŠ¸..."
        if curl -f -m 30 -H "Origin: $PROD_FRONTEND_URL" $PROD_BACKEND_URL/health; then
          echo "âœ… Production Domain CORS ì •ìƒ ì‘ë™"
        else
          echo "âš ï¸ Production Domain CORS í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
        fi
        
        # Preview URL íŒ¨í„´ìœ¼ë¡œë„ í…ŒìŠ¤íŠ¸
        echo "ğŸ“¡ Preview URL íŒ¨í„´ CORS í…ŒìŠ¤íŠ¸..."
        TEST_PREVIEW_URL="https://xai-community-test-ktsfrank-navercoms-projects.vercel.app"
        if curl -f -m 30 -H "Origin: $TEST_PREVIEW_URL" $PROD_BACKEND_URL/health; then
          echo "âœ… Preview URL íŒ¨í„´ CORS ì •ìƒ ì‘ë™"
        else
          echo "âš ï¸ Preview URL íŒ¨í„´ CORS í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ (ì •ìƒ - ì‹¤ì œ URLì´ ì•„ë‹˜)"
        fi

  # ğŸ“Š ê²°ê³¼ ì•Œë¦¼
  notification:
    needs: [backend-safe-checks, frontend-safe-checks, deployment-verification]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ‰ Success notification
      if: needs.backend-safe-checks.result == 'success' && needs.frontend-safe-checks.result == 'success'
      run: |
        echo "ğŸ‰ ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼!"
        echo "âœ… ë°±ì—”ë“œ: ${{ needs.backend-safe-checks.result }}"
        echo "âœ… í”„ëŸ°íŠ¸ì—”ë“œ: ${{ needs.frontend-safe-checks.result }}"
        echo "ğŸŒ ë°±ì—”ë“œ URL: $PROD_BACKEND_URL"
        echo "ğŸŒ í”„ëŸ°íŠ¸ì—”ë“œ URL: $PROD_FRONTEND_URL"
        
    - name: âŒ Failure notification
      if: needs.backend-safe-checks.result == 'failure' || needs.frontend-safe-checks.result == 'failure'
      run: |
        echo "âŒ ì¼ë¶€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
        echo "ğŸ”§ ë°±ì—”ë“œ: ${{ needs.backend-safe-checks.result }}"
        echo "ğŸ”§ í”„ëŸ°íŠ¸ì—”ë“œ: ${{ needs.frontend-safe-checks.result }}"
        echo "ğŸ“ ì‹¤íŒ¨í•œ ë‹¨ê³„ë¥¼ í™•ì¸í•˜ê³  ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤"