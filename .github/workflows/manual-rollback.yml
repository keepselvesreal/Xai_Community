name: ğŸ”„ Manual Rollback

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë¡¤ë°±í•  í™˜ê²½'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      backend_only:
        description: 'ë°±ì—”ë“œë§Œ ë¡¤ë°±'
        required: false
        default: false
        type: boolean
      frontend_only:
        description: 'í”„ë¡ íŠ¸ì—”ë“œë§Œ ë¡¤ë°±'
        required: false
        default: false
        type: boolean
      backend_revision:
        description: 'ë°±ì—”ë“œ íŠ¹ì • ë¦¬ë¹„ì „ (ì„ íƒì‚¬í•­)'
        required: false
        type: string
      frontend_deployment:
        description: 'í”„ë¡ íŠ¸ì—”ë“œ íŠ¹ì • ë°°í¬ ID (ì„ íƒì‚¬í•­)'
        required: false
        type: string
      skip_verification:
        description: 'ê²€ì¦ ë‹¨ê³„ ê±´ë„ˆë›°ê¸°'
        required: false
        default: false
        type: boolean

jobs:
  manual-rollback:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”‘ Setup Google Cloud Authentication
      id: auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: ğŸ”§ Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: xai-community
        
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: ğŸ”„ Install Vercel CLI
      run: npm install -g vercel
      
    - name: ğŸ”‘ Configure Vercel
      env:
        VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      run: |
        if [ -n "$VERCEL_TOKEN" ]; then
          echo "$VERCEL_TOKEN" | vercel login --stdin
        else
          echo "âš ï¸ VERCEL_TOKENì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
        fi
      
    - name: ğŸ”„ Execute Manual Rollback
      env:
        VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      run: |
        echo "ğŸ¯ ìˆ˜ë™ ë¡¤ë°± ì‹œì‘"
        echo "í™˜ê²½: ${{ github.event.inputs.environment }}"
        echo "ë°±ì—”ë“œ ì „ìš©: ${{ github.event.inputs.backend_only }}"
        echo "í”„ë¡ íŠ¸ì—”ë“œ ì „ìš©: ${{ github.event.inputs.frontend_only }}"
        echo "ë°±ì—”ë“œ ë¦¬ë¹„ì „: ${{ github.event.inputs.backend_revision }}"
        echo "í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬: ${{ github.event.inputs.frontend_deployment }}"
        echo "ê²€ì¦ ê±´ë„ˆë›°ê¸°: ${{ github.event.inputs.skip_verification }}"
        
        # ë¡¤ë°± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        chmod +x ./rollback-full.sh
        chmod +x ./backend/rollback-backend.sh
        chmod +x ./frontend/rollback-frontend.sh
        
        # ë¡¤ë°± ëª…ë ¹ì–´ êµ¬ì„±
        ROLLBACK_CMD="./rollback-full.sh -e ${{ github.event.inputs.environment }}"
        
        if [ "${{ github.event.inputs.backend_only }}" = "true" ]; then
          ROLLBACK_CMD="$ROLLBACK_CMD -b"
        fi
        
        if [ "${{ github.event.inputs.frontend_only }}" = "true" ]; then
          ROLLBACK_CMD="$ROLLBACK_CMD -f"
        fi
        
        if [ -n "${{ github.event.inputs.backend_revision }}" ]; then
          ROLLBACK_CMD="$ROLLBACK_CMD -r ${{ github.event.inputs.backend_revision }}"
        fi
        
        if [ -n "${{ github.event.inputs.frontend_deployment }}" ]; then
          ROLLBACK_CMD="$ROLLBACK_CMD -d ${{ github.event.inputs.frontend_deployment }}"
        fi
        
        if [ "${{ github.event.inputs.skip_verification }}" = "true" ]; then
          ROLLBACK_CMD="$ROLLBACK_CMD -s"
        fi
        
        echo "ğŸš€ ì‹¤í–‰í•  ëª…ë ¹ì–´: $ROLLBACK_CMD"
        
        # ìë™ ìŠ¹ì¸ì„ ìœ„í•œ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        echo "y" | $ROLLBACK_CMD
        
        echo "âœ… ìˆ˜ë™ ë¡¤ë°± ì™„ë£Œ"
        
    - name: ğŸ“Š Rollback Summary
      if: always()
      run: |
        echo "ğŸ“‹ ë¡¤ë°± ìš”ì•½:"
        echo "  í™˜ê²½: ${{ github.event.inputs.environment }}"
        echo "  ì‹œì‘ ì‹œê°„: $(date)"
        echo "  ì‹¤í–‰ì: ${{ github.actor }}"
        echo "  ì›Œí¬í”Œë¡œìš° ID: ${{ github.run_id }}"
        echo ""
        echo "ğŸ”— ê´€ë ¨ ë§í¬:"
        if [ "${{ github.event.inputs.environment }}" = "production" ]; then
          echo "  ë°±ì—”ë“œ: https://xai-community-backend-798170408536.asia-northeast3.run.app"
          echo "  í”„ë¡ íŠ¸ì—”ë“œ: https://xai-community.vercel.app"
        else
          echo "  ë°±ì—”ë“œ: https://xai-community-backend-staging-798170408536.asia-northeast3.run.app"
          echo "  í”„ë¡ íŠ¸ì—”ë“œ: https://xai-community-staging.vercel.app"
        fi
        echo "  Google Cloud Console: https://console.cloud.google.com/run"
        echo "  Vercel Dashboard: https://vercel.com/dashboard"