name: ğŸ§ª Cloud Run ì‹¤í—˜ìš© ë°°í¬ (ë””ë²„ê¹… í…ŒìŠ¤íŠ¸)

on:
  push:
    branches: [ main, experiment ]
  pull_request:
    branches: [ main ]

env:
  PROJECT_ID: xai-community
  SERVICE_NAME: cloud-run-experiment
  REGION: asia-northeast3

jobs:
  # ê¸°ë³¸ ê²€ì¦
  basic-checks:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: ğŸ”§ Install uv
      run: |
        pip install uv
    
    - name: ğŸ“¦ Install dependencies
      run: |
        cd cloud-run-experiment
        uv sync --frozen
    
    - name: ğŸ§ª Test app import
      run: |
        cd cloud-run-experiment
        uv run python -c "import main; print('âœ… FastAPI ì•± ì„í¬íŠ¸ ì„±ê³µ')"

  # ğŸ§ª ì‹¤í—˜ìš© Cloud Run ë°°í¬ (experiment ë¸Œëœì¹˜ì—ì„œë§Œ)
  experimental-deployment:
    needs: [basic-checks]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/experiment' && github.event_name == 'push'
    
    defaults:
      run:
        working-directory: ./cloud-run-experiment
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”‘ Setup Google Cloud Authentication
      id: auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    - name: ğŸ”§ Setup Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}
    
    - name: ğŸ§ª ì‹¤í—˜ìš© Cloud Run ë°°í¬ ì‹¤í–‰
      run: |
        echo "ğŸ¯ ì‹¤í—˜ìš© ë°°í¬ ì‹œì‘"
        echo "ğŸ“‚ Branch: ${{ github.ref }}"
        echo "ğŸ”¨ Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Author: ${{ github.actor }}"
        echo ""
        
        # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
        export PROJECT_ID=${{ env.PROJECT_ID }}
        export SERVICE_NAME=${{ env.SERVICE_NAME }}
        export REGION=${{ env.REGION }}
        
        # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        ./deploy.sh
    
    - name: ğŸ” ì‹¤í—˜ìš© ì„œë¹„ìŠ¤ ê²€ì¦
      run: |
        echo "ğŸ” ì‹¤í—˜ìš© ì„œë¹„ìŠ¤ ê²€ì¦ ì‹œì‘"
        echo "â³ ë°°í¬ ì•ˆì •í™” ëŒ€ê¸°..."
        sleep 5
        
        # ì„œë¹„ìŠ¤ URL ê°€ì ¸ì˜¤ê¸°
        SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region=${{ env.REGION }} --format="value(status.url)")
        echo "ğŸŒ ì„œë¹„ìŠ¤ URL: $SERVICE_URL"
        
        # í—¬ìŠ¤ì²´í¬
        echo "ğŸ” í—¬ìŠ¤ì²´í¬..."
        if curl -f -m 30 "$SERVICE_URL/health"; then
          echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ"
        else
          echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
          exit 1
        fi
        
        # ê¸°ë³¸ API í…ŒìŠ¤íŠ¸
        echo "ğŸ” ê¸°ë³¸ API í…ŒìŠ¤íŠ¸..."
        if curl -f -m 30 "$SERVICE_URL/"; then
          echo "âœ… ê¸°ë³¸ API í…ŒìŠ¤íŠ¸ ì„±ê³µ"
        else
          echo "âŒ ê¸°ë³¸ API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
          exit 1
        fi
        
        # í…ŒìŠ¤íŠ¸ ì—”ë“œí¬ì¸íŠ¸ í™•ì¸
        echo "ğŸ” í…ŒìŠ¤íŠ¸ ì—”ë“œí¬ì¸íŠ¸ í™•ì¸..."
        if curl -f -m 30 "$SERVICE_URL/test"; then
          echo "âœ… í…ŒìŠ¤íŠ¸ ì—”ë“œí¬ì¸íŠ¸ ì„±ê³µ"
        else
          echo "âŒ í…ŒìŠ¤íŠ¸ ì—”ë“œí¬ì¸íŠ¸ ì‹¤íŒ¨"
          exit 1
        fi
        
        echo "ğŸ‰ ì‹¤í—˜ìš© ì„œë¹„ìŠ¤ ê²€ì¦ ì™„ë£Œ!"
    
    - name: ğŸ“‹ ë°°í¬ ê²°ê³¼ ìš”ì•½
      run: |
        SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region=${{ env.REGION }} --format="value(status.url)")
        
        echo "ğŸ‰ ì‹¤í—˜ìš© ë°°í¬ ì„±ê³µ!"
        echo ""
        echo "ğŸ“Š ë°°í¬ ì •ë³´:"
        echo "  - í”„ë¡œì íŠ¸: ${{ env.PROJECT_ID }}"
        echo "  - ì„œë¹„ìŠ¤: ${{ env.SERVICE_NAME }}"
        echo "  - ë¦¬ì „: ${{ env.REGION }}"
        echo "  - URL: $SERVICE_URL"
        echo ""
        echo "ğŸ”— í…ŒìŠ¤íŠ¸ URLë“¤:"
        echo "  - ë©”ì¸: $SERVICE_URL"
        echo "  - í—¬ìŠ¤ì²´í¬: $SERVICE_URL/health"
        echo "  - í…ŒìŠ¤íŠ¸: $SERVICE_URL/test"
        echo ""
        echo "ğŸ”§ ê´€ë¦¬ URL:"
        echo "  - Console: https://console.cloud.google.com/run/detail/${{ env.REGION }}/${{ env.SERVICE_NAME }}/metrics?project=${{ env.PROJECT_ID }}"

  # ê²°ê³¼ ì•Œë¦¼
  notification:
    needs: [basic-checks, experimental-deployment]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ‰ ì„±ê³µ ì•Œë¦¼
      if: needs.basic-checks.result == 'success' && (needs.experimental-deployment.result == 'success' || needs.experimental-deployment.result == 'skipped')
      run: |
        echo "ğŸ‰ ì‹¤í—˜ìš© CI/CD íŒŒì´í”„ë¼ì¸ ì„±ê³µ!"
        echo "âœ… ê¸°ë³¸ ê²€ì¦: ${{ needs.basic-checks.result }}"
        if [ "${{ needs.experimental-deployment.result }}" != "skipped" ]; then
          echo "âœ… ì‹¤í—˜ìš© ë°°í¬: ${{ needs.experimental-deployment.result }}"
        fi
        
    - name: âŒ ì‹¤íŒ¨ ì•Œë¦¼
      if: needs.basic-checks.result == 'failure' || needs.experimental-deployment.result == 'failure'
      run: |
        echo "âŒ ì‹¤í—˜ìš© CI/CD íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨"
        echo "ğŸ”§ ê¸°ë³¸ ê²€ì¦: ${{ needs.basic-checks.result }}"
        echo "ğŸ”§ ì‹¤í—˜ìš© ë°°í¬: ${{ needs.experimental-deployment.result }}"
        echo "ğŸ“ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•´ì£¼ì„¸ìš”"