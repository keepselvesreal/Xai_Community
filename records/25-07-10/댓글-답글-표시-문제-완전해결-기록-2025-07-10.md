# ëŒ“ê¸€ ë‹µê¸€ í‘œì‹œ ë¬¸ì œ ì™„ì „ í•´ê²° ê¸°ë¡ - 2025-07-10

## ë¬¸ì œ ìƒí™©

### ì´ˆê¸° ì¦ìƒ
- ê²Œì‹œíŒ í˜ì´ì§€ì—ì„œ ëŒ“ê¸€ì€ ì •ìƒì ìœ¼ë¡œ í‘œì‹œë¨
- ëŒ“ê¸€ì— ë‹µê¸€ì„ ë‹¬ë©´ ë‹µê¸€ì´ í™”ë©´ì— í‘œì‹œë˜ì§€ ì•ŠìŒ
- DBì—ëŠ” ë‹µê¸€ ë°ì´í„°ê°€ ì •ìƒì ìœ¼ë¡œ ì €ì¥ë¨
- ë°±ì—”ë“œ APIëŠ” ì •ìƒ ë™ì‘ ì¤‘

### ë¬¸ì œ ì§„ë‹¨ ê³¼ì •

#### 1ë‹¨ê³„: í”„ë¡ íŠ¸ì—”ë“œ ë””ë²„ê¹…
```javascript
// board.$slug.tsx - ëŒ“ê¸€ ë¡œë”© ë””ë²„ê¹… ì¶”ê°€
console.log('ğŸ” ëŒ“ê¸€ API ì‘ë‹µ êµ¬ì¡° ë¶„ì„:', {
  success: commentsResult.success,
  data: commentsResult.data,
  hasComments: !!commentsResult.data.comments,
  commentsLength: commentsResult.data.comments?.length || 0
});

// ëŒ“ê¸€ ì²˜ë¦¬ ë¡œì§ ë””ë²„ê¹…
console.log('ğŸ” ëŒ“ê¸€ ì²˜ë¦¬:', {
  id: comment.id || comment._id,
  content: comment.content?.substring(0, 50) + '...',
  hasReplies: !!comment.replies,
  repliesCount: comment.replies?.length || 0,
  repliesData: comment.replies
});
```

**ë°œê²¬ëœ ë¬¸ì œ**: ëª¨ë“  ëŒ“ê¸€ì—ì„œ `repliesCount: 0, repliesData: Array(0)`

#### 2ë‹¨ê³„: ë°±ì—”ë“œ API ë””ë²„ê¹…
```python
# comments_service.py - ëŒ“ê¸€ ì¡°íšŒ ë””ë²„ê¹… ì¶”ê°€
print(f"ğŸ” [DEBUG] ëŒ“ê¸€ ì¡°íšŒ - post_slug: {post_slug}")
print(f"ğŸ” [DEBUG] comments_with_replies ìˆ˜: {len(comments_with_replies)}")

# comment_repository.py - ë‹µê¸€ ì¡°íšŒ ë””ë²„ê¹… ì¶”ê°€
print(f"ğŸ” [DEBUG] get_replies ì¿¼ë¦¬: parent_comment_id={parent_comment_id}, status={status}")
replies = await Comment.find(query).sort("created_at").to_list()
print(f"ğŸ” [DEBUG] get_replies ê²°ê³¼: {len(replies)}ê°œ ë‹µê¸€ ë°œê²¬")
```

**ë°œê²¬ëœ ê²°ê³¼**: ë°±ì—”ë“œì—ì„œëŠ” ë‹µê¸€ì„ ì •ìƒì ìœ¼ë¡œ ì¡°íšŒí•¨
- `ğŸ” [DEBUG] get_replies ê²°ê³¼: 2ê°œ ë‹µê¸€ ë°œê²¬`
- `ğŸ” [DEBUG] get_replies ê²°ê³¼: 1ê°œ ë‹µê¸€ ë°œê²¬`

## ê·¼ë³¸ ì›ì¸ ë¶„ì„

### ë¬¸ì œì˜ í•µì‹¬: ìºì‹œ ë¡œì§ê³¼ ë°ì´í„° êµ¬ì¡° ë¶ˆì¼ì¹˜

1. **ëŒ“ê¸€ ì¡°íšŒ ê²½ë¡œê°€ 2ê°œ ì¡´ì¬**:
   - `CommentsService.get_comments_with_user_data()` - ë‹µê¸€ í¬í•¨, ì˜¬ë°”ë¥¸ êµ¬ì¡°
   - `PostsService.get_comments_with_batch_authors()` - ë‹µê¸€ ë¯¸í¬í•¨, ìºì‹œ ë¡œì§

2. **ìºì‹œ ë¡œì§ì´ ìš°ì„  ì‹¤í–‰ë¨**:
   ```python
   # posts_service.py - ê¸°ì¡´ ë¬¸ì œ ì½”ë“œ
   comments, _ = await comment_repository.list_by_post(str(post.id))  # ìµœìƒìœ„ ëŒ“ê¸€ë§Œ ì¡°íšŒ
   ```

3. **ë°ì´í„° êµ¬ì¡° í‰ë©´í™” ë¬¸ì œ**:
   - ë°±ì—”ë“œì—ì„œ `get_comments_with_replies()`ë¡œ ê³„ì¸µì  êµ¬ì¡° ì¡°íšŒ
   - ìºì‹œ ë¡œì§ì—ì„œ `list_by_post()`ë¡œ í‰ë©´ì  êµ¬ì¡° ì €ì¥
   - ë‹µê¸€ ì •ë³´ ì†ì‹¤

## í•´ê²° ë°©ë²•

### 1ë‹¨ê³„: ìºì‹œ ë¡œì§ ìˆ˜ì •
```python
# posts_service.py - ìˆ˜ì •ëœ ì½”ë“œ
# ê¸°ì¡´: í‰ë©´ì  ëŒ“ê¸€ ì¡°íšŒ
comments, _ = await comment_repository.list_by_post(str(post.id))

# ìˆ˜ì •: ê³„ì¸µì  ëŒ“ê¸€ ì¡°íšŒ (ë‹µê¸€ í¬í•¨)
from nadle_backend.config import get_settings
settings = get_settings()
comments_with_replies, _ = await comment_repository.get_comments_with_replies(
    post_id=str(post.id),
    page=1,
    page_size=100,
    status="active",
    max_depth=settings.max_comment_depth
)
```

### 2ë‹¨ê³„: ë°ì´í„° êµ¬ì¡° ì²˜ë¦¬ ë¡œì§ ê°œì„ 
```python
# ëª¨ë“  ëŒ“ê¸€ ID ìˆ˜ì§‘ (ìµœìƒìœ„ ëŒ“ê¸€ + ë‹µê¸€ë“¤)
all_comments = []
def collect_all_comments(item):
    comment = item["comment"]
    replies = item["replies"]
    all_comments.append(comment)
    for reply_item in replies:
        collect_all_comments(reply_item)

for item in comments_with_replies:
    collect_all_comments(item)

# ì¬ê·€ì ìœ¼ë¡œ ì‘ì„±ì ì •ë³´ ê²°í•©
def add_author_info_recursive(item):
    comment = item["comment"]
    replies = item["replies"]
    
    comment_dict = {
        "id": str(comment.id),
        "content": comment.content,
        "author_id": comment.author_id,
        "parent_comment_id": comment.parent_comment_id,
        "created_at": comment.created_at.isoformat(),
        "updated_at": comment.updated_at.isoformat(),
        "status": comment.status,
        "like_count": comment.like_count,
        "dislike_count": comment.dislike_count,
        "reply_count": comment.reply_count,
        "metadata": comment.metadata or {},
        "author": authors_info.get(str(comment.author_id)),
        "replies": [add_author_info_recursive(reply_item) for reply_item in replies]
    }
    return comment_dict
```

### 3ë‹¨ê³„: ìºì‹œ í‚¤ ë²„ì „ ì—…ê·¸ë ˆì´ë“œ
```python
# ê¸°ì¡´ ìºì‹œ ë¬´íš¨í™”ë¥¼ ìœ„í•œ í‚¤ ë³€ê²½
cache_key = f"comments_batch_v2:{post_slug}"  # v1 â†’ v2
```

## ìˆ˜ì •ëœ íŒŒì¼ ëª©ë¡

### ë°±ì—”ë“œ íŒŒì¼
1. **`/backend/nadle_backend/services/posts_service.py`**
   - `get_comments_with_batch_authors()` ë©”ì„œë“œ ì „ë©´ ìˆ˜ì •
   - í‰ë©´ì  ëŒ“ê¸€ ì¡°íšŒ â†’ ê³„ì¸µì  ëŒ“ê¸€ ì¡°íšŒ
   - ì¬ê·€ì  ì‘ì„±ì ì •ë³´ ê²°í•© ë¡œì§ ì¶”ê°€

2. **`/backend/nadle_backend/services/comments_service.py`**
   - ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
   - ë‹µê¸€ ìƒì„±/ì¡°íšŒ ê³¼ì • ëª¨ë‹ˆí„°ë§

3. **`/backend/nadle_backend/repositories/comment_repository.py`**
   - `get_replies()` ë©”ì„œë“œì— ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
   - ë‹µê¸€ ì¡°íšŒ ì¿¼ë¦¬ ì‹¤í–‰ ê³¼ì • ì¶”ì 

4. **`/backend/nadle_backend/routers/comments.py`**
   - ë¼ìš°í„° í˜¸ì¶œ ì¶”ì  ë¡œê·¸ ì¶”ê°€

### í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼
1. **`/frontend/app/routes/board.$slug.tsx`**
   - ëŒ“ê¸€ API ì‘ë‹µ êµ¬ì¡° ë¶„ì„ ë¡œê·¸ ì¶”ê°€
   - ì¤‘ì²©ëœ ë°ì´í„° êµ¬ì¡° ì²˜ë¦¬ ë¡œì§ ê°œì„ 
   - `commentsResult.data.data?.comments` ê²½ë¡œ ì§€ì›

2. **`/frontend/app/components/comment/CommentSection.tsx`**
   - ëŒ“ê¸€ ë Œë”ë§ ìƒíƒœ ë””ë²„ê¹… ì¶”ê°€
   - íƒ€ì… ì˜¤ë¥˜ ìˆ˜ì •

## ê¸°ìˆ ì  ì„¸ë¶€ì‚¬í•­

### ë°ì´í„° êµ¬ì¡° ë³€í™”

#### ê¸°ì¡´ (ë¬¸ì œ ìƒí™©)
```json
{
  "comments": [
    {
      "id": "comment1",
      "content": "ëŒ“ê¸€ ë‚´ìš©",
      "replies": []  // í•­ìƒ ë¹ˆ ë°°ì—´
    }
  ]
}
```

#### ìˆ˜ì • í›„ (í•´ê²°ë¨)
```json
{
  "comments": [
    {
      "id": "comment1",
      "content": "ëŒ“ê¸€ ë‚´ìš©",
      "replies": [
        {
          "id": "reply1",
          "content": "ë‹µê¸€ ë‚´ìš©",
          "parent_comment_id": "comment1",
          "replies": []
        }
      ]
    }
  ]
}
```

### ì„±ëŠ¥ ìµœì í™” ê³ ë ¤ì‚¬í•­

1. **ë°°ì¹˜ ì‘ì„±ì ì •ë³´ ì¡°íšŒ ìœ ì§€**
   - ëª¨ë“  ëŒ“ê¸€(ë‹µê¸€ í¬í•¨)ì˜ ì‘ì„±ì ID ìˆ˜ì§‘
   - ë‹¨ì¼ ì¿¼ë¦¬ë¡œ ì‘ì„±ì ì •ë³´ ë°°ì¹˜ ì¡°íšŒ
   - N+1 ì¿¼ë¦¬ ë¬¸ì œ ë°©ì§€

2. **ìºì‹œ íš¨ìœ¨ì„± ê°œì„ **
   - ë‹µê¸€ í¬í•¨í•œ ì™„ì „í•œ ëŒ“ê¸€ êµ¬ì¡° ìºì‹œ
   - TTL 5ë¶„ ìœ ì§€
   - ë²„ì „ë³„ ìºì‹œ í‚¤ ê´€ë¦¬

3. **ì¬ê·€ì  ì²˜ë¦¬ ìµœì í™”**
   - ìµœëŒ€ ê¹Šì´ ì œí•œ (3ë‹¨ê³„)
   - ë©”ëª¨ë¦¬ íš¨ìœ¨ì ì¸ ì¬ê·€ í•¨ìˆ˜ êµ¬í˜„

## ê²€ì¦ ê²°ê³¼

### ë°±ì—”ë“œ ë¡œê·¸ í™•ì¸
```
ğŸ” [DEBUG] get_replies ê²°ê³¼: 2ê°œ ë‹µê¸€ ë°œê²¬
ğŸ” [DEBUG] get_replies ê²°ê³¼: 1ê°œ ë‹µê¸€ ë°œê²¬
ğŸ“Š ë°°ì¹˜ ì¡°íšŒë¡œ 9ê°œ ëŒ“ê¸€ì— 1ëª…ì˜ ì‘ì„±ì ì •ë³´ ê²°í•© ì™„ë£Œ
```

### í”„ë¡ íŠ¸ì—”ë“œ ë¡œê·¸ í™•ì¸
```javascript
ğŸ” ëŒ“ê¸€ ì²˜ë¦¬: {
  id: 'comment1',
  hasReplies: true,
  repliesCount: 2,  // ì´ì œ ì‹¤ì œ ë‹µê¸€ ìˆ˜ í‘œì‹œ
  repliesData: [...] // ì‹¤ì œ ë‹µê¸€ ë°ì´í„° í¬í•¨
}
```

## ì¶”ê°€ ê°œì„  ì‚¬í•­

1. **ì—ëŸ¬ í•¸ë“¤ë§ ê°•í™”**
   - ë‹µê¸€ ì¡°íšŒ ì‹¤íŒ¨ ì‹œ fallback ë¡œì§
   - ë¶€ë¶„ì  ë°ì´í„° ì†ì‹¤ ì‹œ ë³µêµ¬ ë©”ì»¤ë‹ˆì¦˜

2. **ëª¨ë‹ˆí„°ë§ ê°œì„ **
   - ë‹µê¸€ í‘œì‹œ ì„±ê³µë¥  ë©”íŠ¸ë¦­ ì¶”ê°€
   - ìºì‹œ íˆíŠ¸ìœ¨ ëª¨ë‹ˆí„°ë§

3. **í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì¶”ê°€**
   - ì¤‘ì²© ë‹µê¸€ í‘œì‹œ í…ŒìŠ¤íŠ¸
   - ìºì‹œ ë¬´íš¨í™” í…ŒìŠ¤íŠ¸
   - ë™ì‹œì„± í…ŒìŠ¤íŠ¸

## êµí›ˆ ë° ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤

1. **ìºì‹œì™€ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë¶„ë¦¬**
   - ìºì‹œ ë¡œì§ì´ ë°ì´í„° êµ¬ì¡°ë¥¼ ë³€ê²½í•˜ì§€ ì•Šë„ë¡ ì£¼ì˜
   - ì›ë³¸ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ë³´ì¡´í•˜ë©´ì„œ ìºì‹œ ì ìš©

2. **ë””ë²„ê¹… ë¡œê·¸ì˜ ì¤‘ìš”ì„±**
   - ë³µì¡í•œ ë°ì´í„° íë¦„ì—ì„œëŠ” ì¶©ë¶„í•œ ë¡œê¹… í•„ìˆ˜
   - ë¬¸ì œ ë°œìƒ ì‹œ ë¹ ë¥¸ ì›ì¸ íŒŒì•… ê°€ëŠ¥

3. **ë°ì´í„° êµ¬ì¡° ì¼ê´€ì„± ìœ ì§€**
   - API ì‘ë‹µ êµ¬ì¡° ë³€ê²½ ì‹œ ëª¨ë“  ê³„ì¸µì—ì„œ ì¼ê´€ì„± í™•ì¸
   - ì¤‘ì²© ë°ì´í„° ì²˜ë¦¬ ì‹œ êµ¬ì¡° ë³´ì¡´ ì¤‘ìš”

4. **ë‹¨ê³„ë³„ ì ‘ê·¼ë²•**
   - í”„ë¡ íŠ¸ì—”ë“œ â†’ ë°±ì—”ë“œ ìˆœì„œë¡œ ë¬¸ì œ ë²”ìœ„ ì¢íˆê¸°
   - ê° ë‹¨ê³„ì—ì„œ ì¶©ë¶„í•œ ê²€ì¦ í›„ ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰

## ê²°ë¡ 

ëŒ“ê¸€ ë‹µê¸€ í‘œì‹œ ë¬¸ì œëŠ” **ìºì‹œ ë¡œì§ì—ì„œ ë°ì´í„° êµ¬ì¡°ê°€ í‰ë©´í™”ë˜ë©´ì„œ ë‹µê¸€ ì •ë³´ê°€ ì†ì‹¤**ë˜ëŠ” ê²ƒì´ ê·¼ë³¸ ì›ì¸ì´ì—ˆìŠµë‹ˆë‹¤. 

ìºì‹œ ë¡œì§ì„ ìˆ˜ì •í•˜ì—¬ ë‹µê¸€ì„ í¬í•¨í•œ ê³„ì¸µì  ë°ì´í„° êµ¬ì¡°ë¥¼ ìœ ì§€í•˜ë„ë¡ í•˜ê³ , ì¬ê·€ì ìœ¼ë¡œ ì‘ì„±ì ì •ë³´ë¥¼ ê²°í•©í•˜ëŠ” ë¡œì§ì„ êµ¬í˜„í•¨ìœ¼ë¡œì¨ ë¬¸ì œë¥¼ ì™„ì „íˆ í•´ê²°í–ˆìŠµë‹ˆë‹¤.

ì´ ê³¼ì •ì—ì„œ ë³µì¡í•œ ë°ì´í„° íë¦„ì—ì„œëŠ” **ì¶©ë¶„í•œ ë””ë²„ê¹… ë¡œê·¸**ì™€ **ë‹¨ê³„ë³„ ê²€ì¦**ì´ ì–¼ë§ˆë‚˜ ì¤‘ìš”í•œì§€ ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.